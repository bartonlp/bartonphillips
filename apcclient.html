<!DOCTYPE HTML>
<html>
<head>
<title>WebSocket</title>
<meta charset='utf-8'>
<style>
 body{font:normal 0.9em arial,helvetica;}
 #msg { width:330px; }
 #msgout { height: 100px; border: 1px solid black; padding 10px; overflow: auto; }
 #syslog { border: 1px solid black; padding: 10px; height: 200px; overflow: auto; }
</style>

<script>
var socket, line;

function init() {
  if(!WebSocket in window) alert("no sockets");
  else {
    var host = "ws://127.0.0.1:12345";
//    var host = "ws://69.43.195.42:12345";

    try{
      socket = new WebSocket(host, "tail");

      msgout('WebSocket - status '+socket.readyState);

      socket.onerror = function(msg) {
        console.log(msg);
      }
      
      socket.onopen    = function(msg) {
        msgout("Welcome - status "+this.readyState);
      };
      socket.onmessage = function(msg) {
        var ar = msg.data.split("\n");
        if(ar.length == 1) {
          msgout(msg.data);
        } else if(ar.length == 2) {
          msg = ar.join("<br>");
          syslog(msg);
        } else {
          msg = '<table border="1">\n<caption>APC Status Log</caption>';
          for(var x in ar) {
            //alert(ar[x]);
            if(line = ar[x].match(/^(DATE|MODEL|STATUS|TIMELEFT|BCHARGE|LINEV|LOADPCT).*?:(.*)$/)) {
              msg += "<tr><td>"+ line[1] + "</td><td>" + line[2] + "</td></tr>"; //log(line);
            }
          }
          msg += "</table>";
          log(msg);
        }
        //log("Received - status "+this.readyState);
        //log("Received: "+msg.data);
      };
      socket.onclose = function(msg) {
        msgout("Close Code: "+ msg.code);
        msgout("Close Reason: "+msg.reason);
        console.log("Close: "+msg, msg);
        msgout("Disconnected - status "+this.readyState);
      };
    } catch(ex) {
      msgout(ex);
    }

    $("msg").focus();
  }
}

function send(x) {
  var txt, msg;
  txt = $("msg");

  if(x) {
    msg = x;
  } else {
    msg = txt.value;
  }
  console.log("msg: "+msg);
  if(!msg){
    alert("Message can not be empty");
    return;
  }
  txt.value="";
  txt.focus();
  try {
    socket.send(msg);
    msgout('Sent: '+msg);
  } catch(ex) {
    msgout(ex);
  }
}

function quit() {
  msgout("Goodbye!");
  send("Goodbye");
  socket.close();
}

// Utilities
function $(id) {
  return document.getElementById(id);
}
function log(msg) {
  $("log").innerHTML=msg;
}
function msgout(msg) {
  $("msgout").innerHTML += msg+"<br>";
  var objDiv = $("msgout");
  objDiv.scrollTop = objDiv.scrollHeight;
}
function syslog(msg) {
  $("syslog").innerHTML += msg;
  var objDiv = $("syslog");
  objDiv.scrollTop = objDiv.scrollHeight;
}
function onkey(event) {
  if(event.keyCode==13){
    send();
  }
}
</script>

</head>
<body onload="init()">
 <h3>WebSocket v2.00</h3>
 <div id="msgout"></div>
 <div id="log"></div>
 <div id="syslog"></div>
 <input id="msg" type="textbox" onkeypress="onkey(event)"/>
 <button onclick="send()">Send</button>
 <button onclick="quit()">Quit</button>
 <div>Commands: hello, hi, name, age, date, time, thanks, bye</div>
</body>
</html>
